{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <!-- Wishlist Section -->
  <h3>Your Wishlist</h3>
  {% if wishlist_items %}
    <div class="row row-cols-2 row-cols-lg-5 g-4">
      {% for item in wishlist_items %}
        {% if not is_guest %}
          {# Authenticated user's WishlistItem #}
          <div class="col" id="wishlist-item-{{ item.id }}">
            <div class="card h-100 shadow-sm">
              <img src="{{ item.product.image.url }}" class="card-img-top" alt="{{ item.product.name }}"
                   style="width: 100%; height: 200px; object-fit: cover;">
              <div class="card-body">
                <h5 class="card-title">{{ item.product.name }}</h5>
                <p class="card-text">
                  Price: Rs {{ item.product.price }}<br>
                  {% if item.product.discount_price %}
                    <span class="text-danger">Discount: Rs {{ item.product.discount_price }}</span><br>
                  {% endif %}
                  <small class="text-muted">
                    Added on: {{ item.added_at|date:"F j, Y" }}
                  </small><br>
                  <small class="text-muted">
                    Priority: {{ item.priority }}
                  </small>
                  {% if item.notes %}
                    <p class="mt-2">Notes: {{ item.notes }}</p>
                  {% endif %}
                </p>
              </div>
              <div class="card-footer text-center">
                <a href="{% url 'product_detail' item.product.slug %}" class="btn btn-primary">View Details</a>
                <!-- Delete Button -->
                <button class="btn btn-danger btn-delete-wishlist" data-item-id="{{ item.id }}">
                  Delete
                </button>
              </div>
            </div>
          </div>
        {% else %}
          {# Guest user's Product (wishlist item from cookie) #}
          <div class="col" id="wishlist-item-{{ item.id }}">
            <div class="card h-100 shadow-sm">
              <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.name }}"
                   style="width: 100%; height: 200px; object-fit: cover;">
              <div class="card-body">
                <h5 class="card-title">{{ item.name }}</h5>
                <p class="card-text">
                  Price: Rs {{ item.price }}<br>
                  {% if item.discount_price %}
                    <span class="text-danger">Discount: Rs {{ item.discount_price }}</span><br>
                  {% endif %}
                  <small class="text-muted">(Guest Wishlist)</small>
                </p>
              </div>
              <div class="card-footer text-center">
                <a href="{% url 'product_detail' item.slug %}" class="btn btn-primary">View Details</a>
                <!-- Delete Button -->
                <button class="btn btn-danger btn-delete-wishlist" data-item-id="{{ item.id }}">
                  Delete
                </button>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p>No items in your wishlist.</p>
  {% endif %}

  <!-- Recommended Products Section -->
  <hr class="my-4">
  <h3>Recommended Products</h3>
  {% if recommended_products %}
    <div class="row row-cols-2 row-cols-lg-5 g-4">
      {% for product in recommended_products %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}"
               style="width: 100%; height: 200px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text">
              Price: Rs {{ product.price }}<br>
              {% if product.discount_price %}
                <span class="text-danger">Discount: Rs {{ product.discount_price }}</span>
              {% endif %}
            </p>
            <div class="rating">
              {% include 'partials/star_rating.html' with rating=product.average_rating %}
            </div>
          </div>
          <div class="card-footer text-center">
            <a href="{% url 'product_detail' product.slug %}" class="btn btn-primary">View Details</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p>No recommended products available.</p>
  {% endif %}
</div>

<!-- JavaScript for AJAX Deletion -->
<script>
// Function to get the CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
  const deleteButtons = document.querySelectorAll('.btn-delete-wishlist');

  deleteButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const itemId = this.getAttribute('data-item-id');

      if (!confirm('Are you sure you want to delete this item from your wishlist?')) {
        return;
      }

      fetch(`/wishlist/delete/${itemId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const wishlistItem = document.getElementById(`wishlist-item-${itemId}`);
          if (wishlistItem) {
            wishlistItem.remove();
          }
        } else {
          alert(data.error || 'There was an error deleting the item.');
        }
      })
      .catch(error => {
        console.error('Error deleting wishlist item:', error);
      });
    });
  });
});
</script>
{% endblock %}
